# 5章 大規模開発での並行処理

パターンの組み合わせて、大きく、構成可能で、スケールシステムをかけるようにする慣例を見る。

5章の特徴：

- 単一のプロセス内の並行処理尾をスケールさせる方法で議論
- 1つ以上のプロセスを扱うときにどのように並行処理が関係してくるかを見る。

## 5.1 エラー伝播

エラー伝播はリターンが多い(しない場合のリスクが高い)。さらに少しの配慮と最小限の手間ですむ。

4.5 の議論では、どのように伝播させるかという点についての話であり、
本節では:
- どのような形式になっているべきか、
- あるいはエラーを大きくて複雑なシステム内でどう伝えるか

エラーの内容物：

- 何が起きたか
- いつどこでエラーが発生したか : 
  - どこから始まってどこでエラーが発生して、どう終わったかについての完全なスタックトレースを常に含んでいるべき
  - それはエラーメッセージ内に含まれるべきではないが、ハンドリングしやすいようにスタックトレースは読みだせるようにしろ
  - エラーには実行されたときの文脈に関する情報を含むべき
  - 時刻はUTCで保存しろ
- ユーザー向けの読みやすいメッセージ
  - システムとユーザーにわかりやすいようシステムに合わせてカスタマイズすべき
  - 人間に合わせたものであること
  - 一時的なものかどうかにある程度の示唆を与えるものであることが望ましい
- ユーザーがさらに情報を得るにはどうするべきか
  - エラーには識別子がついているべきで、そのエラーに関するすべての情報が含まれた対応するログと相互参照できなければならない
  

エラーの種類は2つあり、これらの境界を自分で定めることができる：

- バグ(システムに合わせて情報の整理をしていないエラー)
- 既知のエッジケース(「生」のエラー)

低水準コンポーネントで起きたエラーについて、低水準コンポーネントの文脈ではきちんとした形になっていても、それを含む全体ではそうではないかもしれない。
低水準コンポーネントから上に上がってきたエラーはその上がり先のコンポーネント向けにきちんとした形のエラーになるように包んで整えてやらねばならない。
そうしないと、ユーザーの欲しい情報が表示されない。

モジュールの境界において元のエラーを自分のモジュールのエラー型に書き換えろ
- それ以外の不正な形式はエラー
- エラーを内包する必要があるのは、自分のモジュールでの境界、あるいはあなたのコードが有益なコンテキストを追加しうる時だけ

リマーク：
- バグと既知のエッジケースを分けれるようにしろ
- 正しい型を持ったエラーが返ってくることはの心理的安全性が高まる
- わかりやすいメッセージを表示しろ
- トラッキングできるようログIDを含めて、参照できるようにしろ

## 5.2 タイムアウトとキャンセル処理

- タイムアウトはシステムを理解できる動作にするために欠かせない
- キャンセル処理はタイムアウトに対する自然な応答の1つ。

並行プロセスがキャンセルされる要因、

並行処理のプロセスにタイムアウトをサポートしてもらいたい理由について

## 5.3 ハートビート

## 5.4 複製されたリクエスト

## 5.5 流量制限

## 5.6 不健全なゴルーチンを直す

## 5.7 まとめ

Goはパターンが面倒にならずに、かつ堅牢で、5章で扱う以下を単純に実施できる。

- システムの問題領域が分散環境になりそうな大きなシステムを必要としたときに、
システムを安定稼働させ理解しやすくするための方法がある
- Goの並行処理のプリミティブが公開の抽象化を行うときにスケールする
